$(document).ready(function(){
    "use strict";

$(".causecontainer").css("visibility", "hidden !important");
$(".pseudo-div").hide();

//Open Modal on button click
$(".open-modal").click(function(e){
    $(".causecontainer").fadeIn(500);
    $(".probootstrap-header").css("opacity","0.6");
    $("footer").css("opacity","0.6");
    $("section").css("opacity","0.6");
    $(".pseudo-div").fadeIn(400);
});

//close modal on outside modal
$(".pseudo-div").click(function(){
    $(".probootstrap-header").css("opacity","1");
    $("footer").css("opacity","1");
    $("section").css("opacity","1");
    $(".pseudo-div").fadeOut(400);
    $(".causecontainer").fadeOut(200);
})

var q1	=$(".q1");
var q2	=$(".q2");
var q3	=$(".q3");
var q4	=$(".q4");
var q5	=$(".q5");
var q6	=$(".q6");
var q7	=$(".q7");
var q8	=$(".q8");
var q9	=$(".q9");
var q10	=$(".q10");
var q11	=$(".q11");
var q12	=$(".q12");
var q13	=$(".q13");
var q14	=$(".q14");
var q15	=$(".q15");
var q16	=$(".q16");
var q17	=$(".q17");
var q18	=$(".q18");
var q19	=$(".q19");
var q20	=$(".q20");
var q21	=$(".q21");
var q22	=$(".q22");
var q23	=$(".q23");
var q24	=$(".q24");
var result= $(" .result");
var recomend=$(".recomendlink");
var others=$(".others");

//Hiding all other questions other than first
q2.hide();
q3.hide();
q4.hide();
q5.hide();
q6.hide();
q7.hide();
q8.hide();
q9.hide();
q10.hide();
q11.hide();
q12.hide();
q13.hide();
q14.hide();
q15.hide();
q16.hide();
q17.hide();
q18.hide();
q19.hide();
q20.hide();
q21.hide();
q22.hide();
q23.hide();
q24.hide();
result.hide();
recomend.hide();
others.hide();


$(".next").click(function(e){
    e.preventDefault();
    var self= this;
    var pclass=this.parentElement.parentElement.className;
    var nextnumber=parseInt(pclass.replace("q",''))+1;
    var nextclass="q"+nextnumber;
    let pselector="."+pclass;
    let nselector="."+nextclass;
    if ($("input[name="+pclass+"]:checked").val()){
        $(pselector).fadeOut(300,function(){
          $(nselector).fadeIn(300);
        });
    }else{
        alert("Please select an option for the question.")
    }
});

$(".finish").click(function(e){
    e.preventDefault();
    if ($("input[name=q24]:checked").val()){
        analyzecause()
    }else{
        alert("Please select an option for the question.")
    }
});
});

function analyzecause(){
    

    // Getting data for prediction
    var r1=parseFloat($("input[name=q1]:checked").val());
    var r2=parseFloat($("input[name=q2]:checked").val());
    var r3=parseFloat($("input[name=q3]:checked").val());
    var r4=parseFloat($("input[name=q4]:checked").val());
    var r5=parseFloat($("input[name=q5]:checked").val());
    var r6=parseFloat($("input[name=q6]:checked").val());
    var r7=parseFloat($("input[name=q7]:checked").val());
    var r8=parseFloat($("input[name=q8]:checked").val());
    var r9=parseFloat($("input[name=q9]:checked").val());
    var r10=parseFloat($("input[name=q10]:checked").val());
    var r11=parseFloat($("input[name=q11]:checked").val());
    var r12=parseFloat($("input[name=q12]:checked").val());
    var r13=parseFloat($("input[name=q13]:checked").val());
    var r14=parseFloat($("input[name=q14]:checked").val());
    var r15=parseFloat($("input[name=q15]:checked").val());
    var r16=parseFloat($("input[name=q16]:checked").val());
    var r17=parseFloat($("input[name=q17]:checked").val());
    var r18=parseFloat($("input[name=q18]:checked").val());
    var r19=parseFloat($("input[name=q19]:checked").val());
    var r20=parseFloat($("input[name=q20]:checked").val());
    var r21=parseFloat($("input[name=q21]:checked").val());
    var r22=parseFloat($("input[name=q22]:checked").val());
    var r23=parseFloat($("input[name=q23]:checked").val());
    var r24=parseFloat($("input[name=q24]:checked").val());
    
    var diab= r1+r2+r3+r4+r5+r6+r7+r8+r9+r10;
    var high= r11+r12+r13+r14+r15+r23+r24;
    var gene= r16;
    var metal= r17+r18+r19+r20+r21+r22;
    var causeset = { "Diabetes": diab, "high blood pressure":high, "Genetics":gene, "Heavy Metal Poisoning":metal };
    var max= Number.NEGATIVE_INFINITY;
    var max_key=undefined;
    for(var key in causeset){
    if(causeset[key] > max)
    {
      max_key = key;
      max = causeset[key];
      }
    }
    evaluated=undefined;
    if (max>0.1){
        evaluated=max_key;
    }else{
        evaluated="Other Causes and we couldn't specifically find that one"
    }
    
    // Showing the final evaluated cause
    $(".q24").fadeOut(300,function(){
        $(".result").fadeIn(300);
        $(".result").delay(2000).html("<h4> <b>The Results are out!</b></h4>\
        Based on the data you provided, we found that the top cause might be <b>"+
        evaluated+"</b>.<br/> <a href='#' class='otherlink'>This can be due to other causes also.</a> <br/>\
        <a href='contribute' class='report'>Report inappropriate results?</a><br/><br/><br/>\
        <font color='white' style='background-color:black;'> Why not get a personal recommendation to fight its cause?</font><br/> <button class='recomendlink btn btn-success' style='border-radius:0px;padding-top:14px;padding-bottom:14px;'>Yes, I'm in.</button>");
        var recomendlink=r=document.querySelector(".recomendlink");
        var otherlink=document.querySelector(".otherlink");
        var back=document.querySelector(".back");
        
        recomendlink.addEventListener('click',function(){
            window.location.href="laststeps?pass="+evaluated;
        });
        if (evaluated=="Other Causes and we couldn't specifically find that one"){
            otherlink.addEventListener('click',function(){
                alert("Since we couldn't find a particular cause, you are recommended to consult a specialist doctor immediately.")
            })
        }
        else{
            otherlink.addEventListener('click',function(e){
            e.preventDefault();
            $(".result").fadeOut(300,function(){
                $(".others").fadeIn(300)
            })
            })
        }
        back.addEventListener('click',function(e){
          e.preventDefault();
            $(".others").fadeOut(300,function(){
                $(".result").fadeIn(300)
            })
        })  
    });
    
    // Logging data submitted into our database
    db.collection("classify-cause").add({
        diabetes:diab,
        highbp:high,
        genetics:gene,
        heavymetal:metal,
        evaluated:evaluated,
        time: new Date()
    })
}